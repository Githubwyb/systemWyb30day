#include "color.h"

// 声明外部汇编函数
extern void io_hlt(void);
extern void io_cli(void);
extern void io_out8(int port, int data);
extern int  io_load_eflags(void);
extern void io_store_eflags(int eflags);

static void set_palette(int start, int end, unsigned char *rgb);

void init_palette() {
    static unsigned char table_rgb[256 * 3] = {
        0xff, 0x00, 0x00, /*  1:亮红 */
        0x00, 0xff, 0x00, /*  2:亮绿 */
        0xff, 0xff, 0x00, /*  3:亮黄 */
        0x00, 0x00, 0xff, /*  4:亮青 */
        0xff, 0x00, 0xff, /*  5:亮紫 */
        0x00, 0xff, 0xff, /*  6:浅亮蓝 */
        0xff, 0xff, 0xff, /*  7:白 */
        0xc6, 0xc6, 0xc6, /*  8:亮红 */
        0x84, 0x00, 0x00, /*  9:暗赤 */
        0x00, 0x84, 0x00, /* 10:暗绿 */
        0x84, 0x84, 0x00, /* 11:暗黄 */
        0x00, 0x00, 0x84, /* 12:暗青 */
        0x84, 0x00, 0x84, /* 13:暗紫 */
        0x00, 0x84, 0x84, /* 14:浅暗蓝 */
        0x84, 0x84, 0x84,  /* 15:暗灰 */
        0xFF, 0xFF, 0xFF,   // 0: 白
        0xFF, 0xFF, 0xCC,   // 1:
        0xFF, 0xFF, 0x99,   // 2:
        0xFF, 0xFF, 0x66,   // 3:
        0xFF, 0xFF, 0x33,   // 4:
        0xFF, 0xFF, 0x00,   // 5:
        0xFF, 0xCC, 0xFF,   // 6:
        0xFF, 0xCC, 0xCC,   // 7:
        0xFF, 0xCC, 0x99,   // 8:
        0xFF, 0xCC, 0x66,   // 9:
        0xFF, 0xCC, 0x33,   // 10:
        0xFF, 0xCC, 0x00,   // 11:
        0xFF, 0x99, 0xFF,   // 12:
        0xFF, 0x99, 0xCC,   // 13:
        0xFF, 0x99, 0x99,   // 14:
        0xFF, 0x99, 0x66,   // 15:
        0xFF, 0x99, 0x33,   // 16:
        0xFF, 0x99, 0x00,   // 17:
        0xFF, 0x66, 0xFF,   // 18:
        0xFF, 0x66, 0xCC,   // 19:
        0xFF, 0x66, 0x99,   // 21:
        0xFF, 0x66, 0x66,   // 22:
        0xFF, 0x66, 0x33,   // 23:
        0xFF, 0x66, 0x00,   // 24:
        0xFF, 0x33, 0xFF,   // 25:
        0xFF, 0x33, 0xCC,   // 26:
        0xFF, 0x33, 0x99,   // 27:
        0xFF, 0x33, 0x66,   // 28:
        0xFF, 0x33, 0x33,   // 29:
        0xFF, 0x33, 0x00,   // 30:
        0xFF, 0x00, 0xFF,   // 31:
        0xFF, 0x00, 0xCC,   // 32:
        0xFF, 0x00, 0x99,   // 33:
        0xFF, 0x00, 0x66,   // 34:
        0xFF, 0x00, 0x33,   // 35:
        0xFF, 0x00, 0x00,   // 36: 亮红
        0x66, 0xFF, 0xFF,   // 37:
        0x66, 0xFF, 0xCC,   // 38:
        0x66, 0xFF, 0x99,   // 2:
        0x66, 0xFF, 0x66,   // 2:
        0x66, 0xFF, 0x33,   // 2:
        0x66, 0xFF, 0x00,   // 2:
        0x66, 0xCC, 0xFF,   // 2:
        0x66, 0xCC, 0xCC,   // 2:
        0x66, 0xCC, 0x99,   // 2:
        0x66, 0xCC, 0x66,   // 2:
        0x66, 0xCC, 0x33,   // 2:
        0x66, 0xCC, 0x00,   // 2:
        0x66, 0x99, 0xFF,   // 2:
        0x66, 0x99, 0xCC,   // 2:
        0x66, 0x99, 0x99,   // 2:
        0x66, 0x99, 0x66,   // 2:
        0x66, 0x99, 0x33,   // 2:
        0x66, 0x99, 0x00,   // 2:
        0x66, 0x66, 0xFF,   // 2:
        0x66, 0x66, 0xCC,   // 2:
        0x66, 0x66, 0x99,   // 2:
        0x66, 0x66, 0x66,   // 2:
        0x66, 0x66, 0x33,   // 2:
        0x66, 0x66, 0x00,   // 2:
        0x66, 0x33, 0xFF,   // 2:
        0x66, 0x33, 0xCC,   // 2:
        0x66, 0x33, 0x99,   // 2:
        0x66, 0x33, 0x66,   // 2:
        0x66, 0x33, 0x33,   // 2:
        0x66, 0x33, 0x00,   // 2:
        0x66, 0x00, 0xFF,   // 2:
        0x66, 0x00, 0xCC,   // 2:
        0x66, 0x00, 0x99,   // 2:
        0x66, 0x00, 0x66,   // 2:
        0x66, 0x00, 0x33,   // 2:
        0x66, 0x00, 0x00,   // 2:
        0xCC, 0xFF, 0xFF,   // 2:
        0xCC, 0xFF, 0xCC,   // 2:
        0xCC, 0xFF, 0x99,   // 2:
        0xCC, 0xFF, 0x66,   // 2:
        0xCC, 0xFF, 0x33,   // 2:
        0xCC, 0xFF, 0x00,   // 2:
        0xCC, 0xCC, 0xFF,   // 2:
        0xCC, 0xCC, 0xCC,   // 2:
        0xCC, 0xCC, 0x99,   // 2:
        0xCC, 0xCC, 0x66,   // 2:
        0xCC, 0xCC, 0x33,   // 2:
        0xCC, 0xCC, 0x00,   // 2:
        0xCC, 0x99, 0xFF,   // 2:
        0xCC, 0x99, 0xCC,   // 2:
        0xCC, 0x99, 0x99,   // 2:
        0xCC, 0x99, 0x66,   // 2:
        0xCC, 0x99, 0x33,   // 2:
        0xCC, 0x99, 0x00,   // 2:
        0xCC, 0x66, 0xFF,   // 2:
        0xCC, 0x66, 0xCC,   // 2:
        0xCC, 0x66, 0x99,   // 2:
        0xCC, 0x66, 0x66,   // 2:
        0xCC, 0x66, 0x33,   // 2:
        0xCC, 0x66, 0x00,   // 2:
        0xCC, 0x33, 0xFF,   // 2:
        0xCC, 0x33, 0xCC,   // 2:
        0xCC, 0x33, 0x99,   // 2:
        0xCC, 0x33, 0x66,   // 2:
        0xCC, 0x33, 0x33,   // 2:
        0xCC, 0x33, 0x00,   // 2:
        0xCC, 0x00, 0xFF,   // 2:
        0xCC, 0x00, 0xCC,   // 2:
        0xCC, 0x00, 0x99,   // 2:
        0xCC, 0x00, 0x66,   // 2:
        0xCC, 0x00, 0x33,   // 2:
        0xCC, 0x00, 0x00,   // 2:
        0x33, 0xFF, 0xFF,   // 2:
        0x33, 0xFF, 0xCC,   // 2:
        0x33, 0xFF, 0x99,   // 2:
        0x33, 0xFF, 0x66,   // 2:
        0x33, 0xFF, 0x33,   // 2:
        0x33, 0xFF, 0x00,   // 2:
        0x33, 0xCC, 0xFF,   // 2:
        0x33, 0xCC, 0xCC,   // 2:
        0x33, 0xCC, 0x99,   // 2:
        0x33, 0xCC, 0x66,   // 2:
        0x33, 0xCC, 0x33,   // 2:
        0x33, 0xCC, 0x00,   // 2:
        0x33, 0x99, 0xFF,   // 2:
        0x33, 0x99, 0xCC,   // 2:
        0x33, 0x99, 0x99,   // 2:
        0x33, 0x99, 0x66,   // 2:
        0x33, 0x99, 0x33,   // 2:
        0x33, 0x99, 0x00,   // 2:
        0x33, 0x66, 0xFF,   // 2:
        0x33, 0x66, 0xCC,   // 2:
        0x33, 0x66, 0x99,   // 2:
        0x33, 0x66, 0x66,   // 2:
        0x33, 0x66, 0x33,   // 2:
        0x33, 0x66, 0x00,   // 2:
        0x33, 0x33, 0xFF,   // 2:
        0x33, 0x33, 0xCC,   // 2:
        0x33, 0x33, 0x99,   // 2:
        0x33, 0x33, 0x66,   // 2:
        0x33, 0x33, 0x33,   // 2:
        0x33, 0x33, 0x00,   // 2:
        0x33, 0x00, 0xFF,   // 2:
        0x33, 0x00, 0xCC,   // 2:
        0x33, 0x00, 0x99,   // 2:
        0x33, 0x00, 0x66,   // 2:
        0x33, 0x00, 0x33,   // 2:
        0x33, 0x00, 0x00,   // 2:
        0x99, 0xFF, 0xFF,   // 2:
        0x99, 0xFF, 0xCC,   // 2:
        0x99, 0xFF, 0x99,   // 2:
        0x99, 0xFF, 0x66,   // 2:
        0x99, 0xFF, 0x33,   // 2:
        0x99, 0xFF, 0x00,   // 2:
        0x99, 0xCC, 0xFF,   // 2:
        0x99, 0xCC, 0xCC,   // 2:
        0x99, 0xCC, 0x99,   // 2:
        0x99, 0xCC, 0x66,   // 2:
        0x99, 0xCC, 0x33,   // 2:
        0x99, 0xCC, 0x00,   // 2:
        0x99, 0x99, 0xFF,   // 2:
        0x99, 0x99, 0xCC,   // 2:
        0x99, 0x99, 0x99,   // 2:
        0x99, 0x99, 0x66,   // 2:
        0x99, 0x99, 0x33,   // 2:
        0x99, 0x99, 0x00,   // 2:
        0x99, 0x66, 0xFF,   // 2:
        0x99, 0x66, 0xCC,   // 2:
        0x99, 0x66, 0x99,   // 2:
        0x99, 0x66, 0x66,   // 2:
        0x99, 0x66, 0x33,   // 2:
        0x99, 0x66, 0x00,   // 2:
        0x99, 0x33, 0xFF,   // 2:
        0x99, 0x33, 0xCC,   // 2:
        0x99, 0x33, 0x99,   // 2:
        0x99, 0x33, 0x66,   // 2:
        0x99, 0x33, 0x33,   // 2:
        0x99, 0x33, 0x00,   // 2:
        0x99, 0x00, 0xFF,   // 2:
        0x99, 0x00, 0xCC,   // 2:
        0x99, 0x00, 0x99,   // 2:
        0x99, 0x00, 0x66,   // 2:
        0x99, 0x00, 0x33,   // 2:
        0x99, 0x00, 0x00,   // 2:
        0x00, 0xFF, 0xFF,   // 2:
        0x00, 0xFF, 0xCC,   // 2:
        0x00, 0xFF, 0x99,   // 2:
        0x00, 0xFF, 0x66,   // 2:
        0x00, 0xFF, 0x33,   // 2:
        0x00, 0xFF, 0x00,   // 2:
        0x00, 0xCC, 0xFF,   // 2:
        0x00, 0xCC, 0xCC,   // 2:
        0x00, 0xCC, 0x99,   // 2:
        0x00, 0xCC, 0x66,   // 2:
        0x00, 0xCC, 0x33,   // 2:
        0x00, 0xCC, 0x00,   // 2:
        0x00, 0x99, 0xFF,   // 2:
        0x00, 0x99, 0xCC,   // 2:
        0x00, 0x99, 0x99,   // 2:
        0x00, 0x99, 0x66,   // 2:
        0x00, 0x99, 0x33,   // 2:
        0x00, 0x99, 0x00,   // 2:
        0x00, 0x66, 0xFF,   // 2:
        0x00, 0x66, 0xCC,   // 2:
        0x00, 0x66, 0x99,   // 2:
        0x00, 0x66, 0x66,   // 2:
        0x00, 0x66, 0x33,   // 2:
        0x00, 0x66, 0x00,   // 2:
        0x00, 0x33, 0xFF,   // 2:
        0x00, 0x33, 0xCC,   // 2:
        0x00, 0x33, 0x99,   // 2:
        0x00, 0x33, 0x66,   // 2:
        0x00, 0x33, 0x33,   // 2:
        0x00, 0x33, 0x00,   // 2:
        0x00, 0x00, 0xFF,   // 2:
        0x00, 0x00, 0xCC,   // 2:
        0x00, 0x00, 0x99,   // 2:
        0x00, 0x00, 0x66,   // 2:
        0x00, 0x00, 0x33,   // 2:
        0x00, 0x00, 0x00    // 255: 黑
    };
    set_palette(0, 255, table_rgb);
}

void set_palette(int start, int end, unsigned char *rgb) {
    int i, eflags;
    eflags = io_load_eflags(); /* 记录终端许可标志的值 */
    io_cli();                  /* 将许可标志置0，禁止中断 */
    io_out8(0x03c8, start);
    for (i = start; i <= end; i++) {
        io_out8(0x03c9, rgb[0] / 4);
        io_out8(0x03c9, rgb[1] / 4);
        io_out8(0x03c9, rgb[2] / 4);
        rgb += 3;
    }
    io_store_eflags(eflags); /* 恢复许可标志 */
}

void HariMain(void) {
    int   i;
    char *p;

    p = (char *)0xa0000;
    for (i = 0x00000; i < 0x0ffff; ++i) {
        p[i] = i & 0x0f;
    }

    for (;;) {
        io_hlt();
    }
}
