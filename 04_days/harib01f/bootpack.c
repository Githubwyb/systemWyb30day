#include "color.h"

// 声明外部汇编函数
extern void io_hlt(void);
extern void io_cli(void);
extern void io_out8(int port, int data);
extern int  io_load_eflags(void);
extern void io_store_eflags(int eflags);

static void set_palette(int start, int end, unsigned char *rgb);

void init_palette() {
    static unsigned char table_rgb[256 * 3] = {
        0xFF, 0xFF, 0xFF,  // 0: 白
        0xFF, 0xFF, 0xCC,  // 1:
        0xFF, 0xFF, 0x99,  // 2:
        0xFF, 0xFF, 0x66,  // 3:
        0xFF, 0xFF, 0x33,  // 4:
        0xFF, 0xFF, 0x00,  // 5: 亮黄
        0xFF, 0xCC, 0xFF,  // 6:
        0xFF, 0xCC, 0xCC,  // 7:
        0xFF, 0xCC, 0x99,  // 8:
        0xFF, 0xCC, 0x66,  // 9:
        0xFF, 0xCC, 0x33,  // 10:
        0xFF, 0xCC, 0x00,  // 11:
        0xFF, 0x99, 0xFF,  // 12:
        0xFF, 0x99, 0xCC,  // 13:
        0xFF, 0x99, 0x99,  // 14:
        0xFF, 0x99, 0x66,  // 15:
        0xFF, 0x99, 0x33,  // 16:
        0xFF, 0x99, 0x00,  // 17:
        0xFF, 0x66, 0xFF,  // 18:
        0xFF, 0x66, 0xCC,  // 19:
        0xFF, 0x66, 0x99,  // 20:
        0xFF, 0x66, 0x66,  // 21:
        0xFF, 0x66, 0x33,  // 22:
        0xFF, 0x66, 0x00,  // 23:
        0xFF, 0x33, 0xFF,  // 24:
        0xFF, 0x33, 0xCC,  // 25:
        0xFF, 0x33, 0x99,  // 26:
        0xFF, 0x33, 0x66,  // 27:
        0xFF, 0x33, 0x33,  // 28:
        0xFF, 0x33, 0x00,  // 29:
        0xFF, 0x00, 0xFF,  // 30: 亮紫
        0xFF, 0x00, 0xCC,  // 31:
        0xFF, 0x00, 0x99,  // 32:
        0xFF, 0x00, 0x66,  // 33:
        0xFF, 0x00, 0x33,  // 34:
        0xFF, 0x00, 0x00,  // 35: 亮红
        0x66, 0xFF, 0xFF,  // 36:
        0x66, 0xFF, 0xCC,  // 37:
        0x66, 0xFF, 0x99,  // 38:
        0x66, 0xFF, 0x66,  // 39:
        0x66, 0xFF, 0x33,  // 40:
        0x66, 0xFF, 0x00,  // 41:
        0x66, 0xCC, 0xFF,  // 42:
        0x66, 0xCC, 0xCC,  // 43:
        0x66, 0xCC, 0x99,  // 44:
        0x66, 0xCC, 0x66,  // 45:
        0x66, 0xCC, 0x33,  // 46:
        0x66, 0xCC, 0x00,  // 47:
        0x66, 0x99, 0xFF,  // 48:
        0x66, 0x99, 0xCC,  // 49:
        0x66, 0x99, 0x99,  // 50:
        0x66, 0x99, 0x66,  // 51:
        0x66, 0x99, 0x33,  // 52:
        0x66, 0x99, 0x00,  // 53:
        0x66, 0x66, 0xFF,  // 54:
        0x66, 0x66, 0xCC,  // 55:
        0x66, 0x66, 0x99,  // 56:
        0x66, 0x66, 0x66,  // 57:
        0x66, 0x66, 0x33,  // 58:
        0x66, 0x66, 0x00,  // 59:
        0x66, 0x33, 0xFF,  // 60:
        0x66, 0x33, 0xCC,  // 61:
        0x66, 0x33, 0x99,  // 62:
        0x66, 0x33, 0x66,  // 63:
        0x66, 0x33, 0x33,  // 64:
        0x66, 0x33, 0x00,  // 65:
        0x66, 0x00, 0xFF,  // 66:
        0x66, 0x00, 0xCC,  // 67:
        0x66, 0x00, 0x99,  // 68:
        0x66, 0x00, 0x66,  // 69:
        0x66, 0x00, 0x33,  // 70:
        0x66, 0x00, 0x00,  // 71:
        0xCC, 0xFF, 0xFF,  // 72:
        0xCC, 0xFF, 0xCC,  // 73:
        0xCC, 0xFF, 0x99,  // 74:
        0xCC, 0xFF, 0x66,  // 75:
        0xCC, 0xFF, 0x33,  // 76:
        0xCC, 0xFF, 0x00,  // 77:
        0xCC, 0xCC, 0xFF,  // 78:
        0xCC, 0xCC, 0xCC,  // 79:
        0xCC, 0xCC, 0x99,  // 80:
        0xCC, 0xCC, 0x66,  // 81:
        0xCC, 0xCC, 0x33,  // 82:
        0xCC, 0xCC, 0x00,  // 83:
        0xCC, 0x99, 0xFF,  // 84:
        0xCC, 0x99, 0xCC,  // 85:
        0xCC, 0x99, 0x99,  // 86:
        0xCC, 0x99, 0x66,  // 87:
        0xCC, 0x99, 0x33,  // 88:
        0xCC, 0x99, 0x00,  // 89:
        0xCC, 0x66, 0xFF,  // 90:
        0xCC, 0x66, 0xCC,  // 91:
        0xCC, 0x66, 0x99,  // 92:
        0xCC, 0x66, 0x66,  // 93:
        0xCC, 0x66, 0x33,  // 94:
        0xCC, 0x66, 0x00,  // 95:
        0xCC, 0x33, 0xFF,  // 96:
        0xCC, 0x33, 0xCC,  // 97:
        0xCC, 0x33, 0x99,  // 98:
        0xCC, 0x33, 0x66,  // 99:
        0xCC, 0x33, 0x33,  // 100:
        0xCC, 0x33, 0x00,  // 101:
        0xCC, 0x00, 0xFF,  // 102:
        0xCC, 0x00, 0xCC,  // 103:
        0xCC, 0x00, 0x99,  // 104:
        0xCC, 0x00, 0x66,  // 105:
        0xCC, 0x00, 0x33,  // 106:
        0xCC, 0x00, 0x00,  // 107:
        0x33, 0xFF, 0xFF,  // 108:
        0x33, 0xFF, 0xCC,  // 109:
        0x33, 0xFF, 0x99,  // 110:
        0x33, 0xFF, 0x66,  // 111:
        0x33, 0xFF, 0x33,  // 112:
        0x33, 0xFF, 0x00,  // 113:
        0x33, 0xCC, 0xFF,  // 114:
        0x33, 0xCC, 0xCC,  // 115:
        0x33, 0xCC, 0x99,  // 116:
        0x33, 0xCC, 0x66,  // 117:
        0x33, 0xCC, 0x33,  // 118:
        0x33, 0xCC, 0x00,  // 119:
        0x33, 0x99, 0xFF,  // 120:
        0x33, 0x99, 0xCC,  // 121:
        0x33, 0x99, 0x99,  // 122:
        0x33, 0x99, 0x66,  // 123:
        0x33, 0x99, 0x33,  // 124:
        0x33, 0x99, 0x00,  // 125:
        0x33, 0x66, 0xFF,  // 126:
        0x33, 0x66, 0xCC,  // 127:
        0x33, 0x66, 0x99,  // 128:
        0x33, 0x66, 0x66,  // 129:
        0x33, 0x66, 0x33,  // 130:
        0x33, 0x66, 0x00,  // 131:
        0x33, 0x33, 0xFF,  // 132:
        0x33, 0x33, 0xCC,  // 133:
        0x33, 0x33, 0x99,  // 134:
        0x33, 0x33, 0x66,  // 135:
        0x33, 0x33, 0x33,  // 136:
        0x33, 0x33, 0x00,  // 137:
        0x33, 0x00, 0xFF,  // 138:
        0x33, 0x00, 0xCC,  // 139:
        0x33, 0x00, 0x99,  // 140:
        0x33, 0x00, 0x66,  // 141:
        0x33, 0x00, 0x33,  // 142:
        0x33, 0x00, 0x00,  // 143:
        0x99, 0xFF, 0xFF,  // 144:
        0x99, 0xFF, 0xCC,  // 145:
        0x99, 0xFF, 0x99,  // 146:
        0x99, 0xFF, 0x66,  // 147:
        0x99, 0xFF, 0x33,  // 148:
        0x99, 0xFF, 0x00,  // 149:
        0x99, 0xCC, 0xFF,  // 150:
        0x99, 0xCC, 0xCC,  // 151:
        0x99, 0xCC, 0x99,  // 152:
        0x99, 0xCC, 0x66,  // 153:
        0x99, 0xCC, 0x33,  // 154:
        0x99, 0xCC, 0x00,  // 155:
        0x99, 0x99, 0xFF,  // 156:
        0x99, 0x99, 0xCC,  // 157:
        0x99, 0x99, 0x99,  // 158:
        0x99, 0x99, 0x66,  // 159:
        0x99, 0x99, 0x33,  // 160:
        0x99, 0x99, 0x00,  // 161:
        0x99, 0x66, 0xFF,  // 162:
        0x99, 0x66, 0xCC,  // 163:
        0x99, 0x66, 0x99,  // 164:
        0x99, 0x66, 0x66,  // 165:
        0x99, 0x66, 0x33,  // 166:
        0x99, 0x66, 0x00,  // 167:
        0x99, 0x33, 0xFF,  // 168:
        0x99, 0x33, 0xCC,  // 169:
        0x99, 0x33, 0x99,  // 170:
        0x99, 0x33, 0x66,  // 171:
        0x99, 0x33, 0x33,  // 172:
        0x99, 0x33, 0x00,  // 173:
        0x99, 0x00, 0xFF,  // 174:
        0x99, 0x00, 0xCC,  // 175:
        0x99, 0x00, 0x99,  // 176:
        0x99, 0x00, 0x66,  // 177:
        0x99, 0x00, 0x33,  // 178:
        0x99, 0x00, 0x00,  // 179:
        0x00, 0xFF, 0xFF,  // 180: 浅蓝
        0x00, 0xFF, 0xCC,  // 181:
        0x00, 0xFF, 0x99,  // 182:
        0x00, 0xFF, 0x66,  // 183:
        0x00, 0xFF, 0x33,  // 184:
        0x00, 0xFF, 0x00,  // 185: 亮绿
        0x00, 0xCC, 0xFF,  // 186:
        0x00, 0xCC, 0xCC,  // 187:
        0x00, 0xCC, 0x99,  // 188:
        0x00, 0xCC, 0x66,  // 189:
        0x00, 0xCC, 0x33,  // 190:
        0x00, 0xCC, 0x00,  // 191:
        0x00, 0x99, 0xFF,  // 192:
        0x00, 0x99, 0xCC,  // 193:
        0x00, 0x99, 0x99,  // 194:
        0x00, 0x99, 0x66,  // 195:
        0x00, 0x99, 0x33,  // 196:
        0x00, 0x99, 0x00,  // 197:
        0x00, 0x66, 0xFF,  // 198:
        0x00, 0x66, 0xCC,  // 199:
        0x00, 0x66, 0x99,  // 200:
        0x00, 0x66, 0x66,  // 201:
        0x00, 0x66, 0x33,  // 202:
        0x00, 0x66, 0x00,  // 203:
        0x00, 0x33, 0xFF,  // 204:
        0x00, 0x33, 0xCC,  // 205:
        0x00, 0x33, 0x99,  // 206:
        0x00, 0x33, 0x66,  // 207:
        0x00, 0x33, 0x33,  // 208:
        0x00, 0x33, 0x00,  // 209:
        0x00, 0x00, 0xFF,  // 210: 亮蓝
        0x00, 0x00, 0xCC,  // 211:
        0x00, 0x00, 0x99,  // 212:
        0x00, 0x00, 0x66,  // 213:
        0x00, 0x00, 0x33,  // 214:
        0x00, 0x00, 0x00   // 215: 黑
    };
    set_palette(0, 255, table_rgb);
}

void set_palette(int start, int end, unsigned char *rgb) {
    int i, eflags;
    eflags = io_load_eflags(); /* 记录终端许可标志的值 */
    io_cli();                  /* 将许可标志置0，禁止中断 */
    io_out8(0x03c8, start);
    for (i = start; i <= end; i++) {
        io_out8(0x03c9, rgb[0] / 4);
        io_out8(0x03c9, rgb[1] / 4);
        io_out8(0x03c9, rgb[2] / 4);
        rgb += 3;
    }
    io_store_eflags(eflags); /* 恢复许可标志 */
}

void HariMain(void) {
    int   i;
    char *p;

    init_palette();
    p = (char *)0xa0000;
    for (i = 0x00000; i < 0x0ffff; ++i) {
        p[i] = i & 0xff;
    }

    for (;;) {
        io_hlt();
    }
}
